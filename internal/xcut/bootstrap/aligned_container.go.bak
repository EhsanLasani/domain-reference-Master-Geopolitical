// Code generated by schema alignment tool. DO NOT EDIT.
package bootstrap

import (
	"fmt"
	"github.com/EhsanLasani/domain-reference-Master-Geopolitical/internal/xcut/cache"
	"github.com/EhsanLasani/domain-reference-Master-Geopolitical/internal/xcut/config"
	"github.com/EhsanLasani/domain-reference-Master-Geopolitical/internal/xcut/logging"
	"github.com/EhsanLasani/domain-reference-Master-Geopolitical/internal/xcut/tracing"
	"github.com/EhsanLasani/domain-reference-Master-Geopolitical/data-access-layer/database"
	models "github.com/EhsanLasani/domain-reference-Master-Geopolitical/data-access-layer/orm-odm-abstractions"
	applicationservices "github.com/EhsanLasani/domain-reference-Master-Geopolitical/business-logic-layer/application-services"
	repositories "github.com/EhsanLasani/domain-reference-Master-Geopolitical/data-access-layer/repositories-daos"
)

// AlignedContainer holds all application dependencies with schema alignment
type AlignedContainer struct {
	Config            *config.Config
	Logger            logging.Logger
	Tracer            tracing.Tracer
	Cache             cache.Cache
	DBManager         *database.Database
	
	// Aligned Repositories
	CountryRepository repositories.AlignedCountryRepositoryInterface
	
	// Aligned Application Services
	CountryAppService *applicationservices.AlignedCountryAppService
}

// NewAlignedContainer creates and initializes the aligned application container
func NewAlignedContainer(cfg *config.Config, logger logging.Logger) (*AlignedContainer, error) {
	// Initialize tracing
	tracer, err := tracing.NewTracer("geopolitical-service-aligned")
	if err != nil {
		return nil, fmt.Errorf("failed to initialize tracer: %w", err)
	}

	// Initialize cache
	cacheClient := cache.NewCache(cfg.Redis.Host, cfg.Redis.Password, cfg.Redis.DB)

	// Initialize database
	dbManager, err := database.NewDatabase(&cfg.Database)
	if err != nil {
		return nil, fmt.Errorf("failed to initialize database: %w", err)
	}

	// Validate existing table structure
	if err := dbManager.CheckAllTables(); err != nil {
		fmt.Printf("Table validation completed with warnings: %v\n", err)
	}
	
	// Auto-migrate all aligned models
	if err := dbManager.AutoMigrate(
		&models.Country{},
		&models.Region{},
		&models.Language{},
		&models.Timezone{},
		&models.CountrySubdivision{},
		&models.Locale{},
	); err != nil {
		return nil, fmt.Errorf("failed to auto-migrate aligned models: %w", err)
	}

	// Initialize aligned repositories
	countryRepo := repositories.NewAlignedCountryRepository(dbManager.DB, cacheClient, logger)

	// Initialize aligned application services
	countryAppService := applicationservices.NewAlignedCountryAppService(countryRepo, logger, tracer)

	return &AlignedContainer{
		Config:            cfg,
		Logger:            logger,
		Tracer:            tracer,
		Cache:             cacheClient,
		DBManager:         dbManager,
		CountryRepository: countryRepo,
		CountryAppService: countryAppService,
	}, nil
}

// Close closes all resources
func (c *AlignedContainer) Close() error {
	if c.DBManager != nil {
		return c.DBManager.Close()
	}
	return nil
}